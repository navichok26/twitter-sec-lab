import pytest

def test_guest_access(client):
    """????? ????? ????????????? ????? ? ??????? ????????"""
    response = client.get('/')
    assert response.status_code == 200
    assert b'Security Twitter Lab' in response.data
    
    response = client.get('/posts')
    assert response.status_code == 200
    assert b'Posts' in response.data
    
    # ????? ?? ????? ????????? ?????
    response = client.get('/post/create')
    assert response.status_code == 302  # Redirect to login

def test_user_can_create_post(client, test_user, test_group):
    """?????????????? ???????????? ????? ??????? ????"""
    # ?????????
    client.post('/login', data={
        'email': 'test@example.com',
        'password': 'password'
    })
    
    response = client.get('/post/create')
    assert response.status_code == 200
    
    # ??????? ????
    response = client.post('/post/create', data={
        'title': 'Test Post',
        'content': 'Test Content',
        'group_id': test_group.id
    }, follow_redirects=True)
    
    assert response.status_code == 200
    assert b'Test Post' in response.data

def test_admin_panel_access(client, test_user, test_main_admin):
    """?????? ?????? ????? ?????? ?????-??????"""
    # ??????? ????????????
    client.post('/login', data={
        'email': 'test@example.com',
        'password': 'password'
    })
    
    response = client.get('/admin')
    assert response.status_code == 403  # Forbidden
    
    # ??????? ?????
    client.get('/logout')
    client.post('/login', data={
        'email': 'main@example.com',
        'password': 'password'
    })
    
    response = client.get('/admin')
    assert response.status_code == 200
    assert b'Admin Dashboard' in response.data

def test_post_transfer_route(client, test_user, test_group):
    """???? ???????? ?????"""
    # ?????????
    client.post('/login', data={
        'email': 'test@example.com',
        'password': 'password'
    })
    
    # ??????? ????
    client.post('/post/create', data={
        'title': 'Post to Transfer',
        'content': 'Content',
        'group_id': test_group.id
    })
    
    # ???????? ??????? ?? ???????? ????????
    response = client.get('/post/1/transfer')
    assert response.status_code == 200
    assert b'Transfer Post Ownership' in response.data

def test_permission_denied(client, test_user, test_group_admin, test_group):
    """???? ?????? ? ??????? ??? ??????? ?????????????? ?????? ?????"""
    # ??????? ???? ?? ????? group_admin
    client.post('/login', data={
        'email': 'admin@example.com',
        'password': 'password'
    })
    
    client.post('/post/create', data={
        'title': 'Admin Post',
        'content': 'Admin Content',
        'group_id': test_group.id
    })
    
    # ??????? ? ????????? ??? ??????? ????????????
    client.get('/logout')
    client.post('/login', data={
        'email': 'test@example.com',
        'password': 'password'
    })
    
    # ???????? ????????????? ???? ??????
    response = client.get('/post/1/edit')
    assert response.status_code == 403  # Forbidden