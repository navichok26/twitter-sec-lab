from functools import wraps
from flask import abort
from flask_login import current_user

class Policy:
    """????? ??? ???????? ???? ??????? (RBAC + DAC)"""
    
    @staticmethod
    def is_main_admin(user):
        return user.is_authenticated and user.role == 'main_admin'
    
    @staticmethod
    def is_group_admin(user):
        return user.is_authenticated and user.role == 'group_admin'
    
    @staticmethod
    def is_user(user):
        return user.is_authenticated and user.role == 'user'
    
    @staticmethod
    def is_guest(user):
        return not user.is_authenticated
    
    @staticmethod
    def can_view_posts(user, group=None):
        """??? ????? ????????????? ?????"""
        return True
    
    @staticmethod
    def can_create_post(user, group):
        """???? ????? ?????????: ??? ???????????? ? ?????? ?????"""
        if not user.is_authenticated:
            return False
        if user.role in ['user', 'group_admin', 'main_admin']:
            return True
        return False
    
    @staticmethod
    def can_edit_post(user, post):
        """????????????? ???? ?????:
        1. ??????? ?????
        2. ????? ??????, ? ??????? ??????????? ????
        3. ??????? ???????? ?????
        """
        if not user.is_authenticated:
            return False
        
        if user.role == 'main_admin':
            return True
        
        if user.role == 'group_admin' and post.group_ref.owner_id == user.id:
            return True
        
        if post.owner_id == user.id:
            return True
        
        return False
    
    @staticmethod
    def can_delete_post(user, post):
        """??????? ???? ????? ?? ??, ??? ????? ?????????????"""
        return Policy.can_edit_post(user, post)
    
    @staticmethod
    def can_transfer_post(user, post):
        """?????????? ???? ????? ?? ??, ??? ????? ?????????????"""
        return Policy.can_edit_post(user, post)
    
    @staticmethod
    def can_manage_group(user, group):
        """????????? ??????? ?????:
        1. ??????? ?????
        2. ???????? ?????? (???? ?? ????? ??????)
        """
        if not user.is_authenticated:
            return False
        
        if user.role == 'main_admin':
            return True
        
        if user.role == 'group_admin' and group.owner_id == user.id:
            return True
        
        return False
    
    @staticmethod
    def can_view_admin_panel(user):
        """????????????? ?????-?????? ????? ?????? ??????"""
        return user.is_authenticated and user.role in ['group_admin', 'main_admin']

# ?????????? ??? ?????????
def main_admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not Policy.is_main_admin(current_user):
            abort(403)
        return f(*args, **kwargs)
    return decorated_function

def group_admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not Policy.is_group_admin(current_user):
            abort(403)
        return f(*args, **kwargs)
    return decorated_function

def login_required_with_role(roles=None):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not current_user.is_authenticated:
                abort(403)
            if roles and current_user.role not in roles:
                abort(403)
            return f(*args, **kwargs)
        return decorated_function
    return decorator